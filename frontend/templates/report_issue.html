<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Report an Issue â€¢ AutoEval</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
      overflow-x: hidden;
      background: #f9fafb;
      font-family: 'Inter', sans-serif;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    main {
  flex: 1;
  width: 100%;
  padding-top: 120px;   /* space for header */
  padding-bottom: 160px; /* larger space for footer overlap */
  padding-left: 24px;
  padding-right: 24px;
  box-sizing: border-box;
}

    footer {
      position: flex;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 999;
    }

    h2, h4 {
      color: #4B0082;
      font-weight: 600;
    }

    .nav-tabs .nav-link.active {
      background: #4B0082;
      color: #fff !important;
      border-color: #4B0082;
    }

    .nav-tabs .nav-link {
      color: #4B0082;
      font-weight: 500;
    }

    .btn-primary {
      background-color: #4B0082;
      border: none;
    }

    .btn-primary:hover {
      background-color: #3a0068;
    }

    .badge.bg-warning {
      background-color: #FFD43B !important;
    }

    .badge.bg-success {
      background-color: #00BFA6 !important;
    }

    .modal-content {
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
  </style>
</head>

<body>

  <!-- ðŸ§­ Sticky Header -->
  <header>
    {% include 'partials/header.html' %}
  </header>

  <!-- ðŸ§± Scrollable Main Content -->
  <main class="container-fluid">
    <div class="container">
      <h2 class="mb-4">Report & Track Issues</h2>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="issueTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab">
            My Issues
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab">
            Report New Issue
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content mt-3" id="issueTabsContent">
        
        <!-- My Issues Tab -->
        <div class="tab-pane fade show active" id="status" role="tabpanel" aria-labelledby="status-tab">
          <h4 class="mb-3">My Reported Issues</h4>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Status</th>
                  <th>Reported At</th>
                  <th>Attachments</th>
                </tr>
              </thead>
              <tbody>
                {% for issue in issues %}
                  <tr>
                    <td>{{ issue.issue_id }}</td>
                    <td>{{ issue.issue_type }}</td>
                    <td>{{ issue.description }}</td>
                    <td>
                      {% if issue.status == "open" %}
                        <span class="badge bg-warning text-dark">Open</span>
                      {% else %}
                        <span class="badge bg-success">Resolved</span>
                      {% endif %}
                    </td>
                    <td>{{ issue.reported_at }}</td>
                    <td>
                      <button class="btn btn-sm btn-info" onclick="showScreenshots({{ issue.issue_id }})">
                        View
                      </button>
                    </td>
                  </tr>
                {% else %}
                  <tr><td colspan="6" class="text-center text-muted">No issues reported yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Report Issue Tab -->
        <div class="tab-pane fade" id="report" role="tabpanel" aria-labelledby="report-tab">
          <h4 class="mb-3">Report a New Issue</h4>
          <form action="{{ url_for('submit_issue') }}" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="user_id" value="{{ user_id }}">
            <input type="hidden" name="page" value="{{ page }}">

            <div class="mb-3">
              <label class="form-label">Issue Type</label>
              <select class="form-control" name="issue_type" required>
                <option value="" disabled selected>Select Issue Type</option>
                <optgroup label="Authentication & Access">
                  <option value="Login Problem">Login Problem</option>
                  <option value="OTP/Verification Issue">OTP/Verification Issue</option>
                  <option value="Session Timeout">Session Timeout</option>
                </optgroup>
                <optgroup label="Profile & Account Management">
                  <option value="Profile Update Error">Profile Update Error</option>
                  <option value="Role Access Issue">Role Access Issue</option>
                  <option value="Wrong Profile Data">Wrong Profile Data</option>
                </optgroup>
                <optgroup label="Assignments & Submissions">
                  <option value="Assignment Not Visible">Assignment Not Visible</option>
                  <option value="Submission Error">Submission Error</option>
                  <option value="Submission Not Recorded">Submission Not Recorded</option>
                  <option value="Late Submission Error">Late Submission Error</option>
                </optgroup>
                <optgroup label="Evaluation & Feedback">
                  <option value="Incorrect Grades">Incorrect Grades</option>
                  <option value="Auto-Evaluation Error">Auto-Evaluation Error</option>
                  <option value="Feedback Missing">Feedback Missing</option>
                  <option value="Plagiarism Report Issue">Plagiarism Report Issue</option>
                </optgroup>
                <optgroup label="System & Technical">
                  <option value="UI Problem">UI Problem</option>
                  <option value="File Upload/Download Issue">File Upload/Download Issue</option>
                  <option value="Slow Performance">Slow Performance</option>
                  <option value="System Crash/Bug">System Crash/Bug</option>
                </optgroup>
                <optgroup label="General & Communication">
                  <option value="Notification Issue">Notification Issue</option>
                  <option value="Data Error">Data Error</option>
                  <option value="Other">Other</option>
                </optgroup>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="4" required></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Attach Screenshots (optional)</label>
              <input type="file" class="form-control" name="screenshots" accept=".png,.jpg,.jpeg,.gif" multiple>
            </div>

            <button type="submit" class="btn btn-primary">Submit Issue</button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <!-- ðŸ§­ Sticky Footer -->
  <footer>
    {% include 'partials/footer.html' %}
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function showScreenshots(issueId) {
      fetch(`/issue/${issueId}/screenshots`)
        .then(res => res.json())
        .then(data => {
          let container = document.getElementById("screenshotContainer");
          let carousel = document.getElementById("screenshotCarousel");
          let carouselInner = document.getElementById("carouselInner");

          container.style.display = "block";
          carousel.style.display = "none";
          container.innerHTML = "";
          carouselInner.innerHTML = "";

          if (data.screenshots.length === 0) {
            container.innerHTML = "<p class='text-muted'>No attachments</p>";
          } else {
            data.screenshots.forEach((sc, index) => {
              container.innerHTML += `
                <img src="/${sc}" class="img-thumbnail m-2" 
                     style="max-width:200px; cursor:pointer;" 
                     onclick="openCarousel(${index})">
              `;
              carouselInner.innerHTML += `
                <div class="carousel-item ${index === 0 ? 'active' : ''}">
                  <img src="/${sc}" class="d-block w-100" style="max-height:80vh;object-fit:contain;">
                </div>
              `;
            });
          }
          new bootstrap.Modal(document.getElementById("screenshotModal")).show();
        });
    }

    function openCarousel(startIndex) {
      document.getElementById("screenshotContainer").style.display = "none";
      let carousel = document.getElementById("screenshotCarousel");
      let items = carousel.querySelectorAll(".carousel-item");

      carousel.style.display = "block";
      items.forEach((item, i) => {
        item.classList.remove("active");
        if (i === startIndex) item.classList.add("active");
      });
    }

    function closeCarousel() {
      document.getElementById("screenshotContainer").style.display = "block";
      document.getElementById("screenshotCarousel").style.display = "none";
    }
  </script>
</body>
</html>
