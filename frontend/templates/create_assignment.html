<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assignment Management</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Select2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #4b0082;
        --secondary: #00bfa6;
        --accent: #ff7e5f;
        --bg: #98ceeeff;
        --card-bg: #ffffff;
        --muted: #555;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      body {
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        color: #333;
        overflow-x: hidden;
      }

      header {
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
      }

      main {
        flex: 1;
        display: flex;
        justify-content: center;
        padding: 100px 20px 100px 20px; /* space for fixed header & footer */
      }

      footer {
        position: flex;
        bottom: 0;
        width: 100%;
        background: #ffffffff;
        color: #888;
        font-size: 14px;
        border-top: 1px solid #eee;
        text-align: center;
        z-index: 999;
      }

      .container {
        width: 100%;
        max-width: 960px;
        min-height: 80vh;
        background: #a6e7d9ff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: var(--shadow);
      }

      .nav-tabs .nav-link.active {
        background: var(--primary);
        color: #fff;
      }

      .card {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow);
        margin-bottom: 20px;
        transition: 0.2s;
      }

      .card:hover {
        transform: translateY(-2px);
      }

      .card-header {
        border-radius: 12px 12px 0 0;
        border-bottom: none;
      }

      .card-body {
        background: #f9fafb;
        border-radius: 0 0 12px 12px;
        padding: 1.5rem;
      }

      label {
        font-weight: 500;
        color: var(--muted);
      }

      .form-control,
      .form-select {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.95rem;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--secondary);
        box-shadow: 0 0 0 0.2rem rgba(0, 191, 166, 0.25);
      }

      .form-check-input {
        accent-color: var(--accent);
      }

      .btn-primary {
        background: var(--secondary);
        border: none;
      }

      .btn-primary:hover {
        background: #019e8a;
      }

      .btn-outline-primary {
        color: var(--secondary);
        border-color: var(--secondary);
      }

      .btn-outline-primary:hover {
        background: #00bfa61a;
      }

      /* Vanta Background */
      #vanta-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
      }

      .tab-content {
        min-height: 600px;
      }
    </style>

    <!-- ✅ JS Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>
    <script src="{{ url_for('static', filename='js/create-assignment.js') }}"></script>
  </head>

  <body>
    <header>{% include 'partials/header.html' %}</header>

    <div id="vanta-bg"></div>

    <main>
      <div class="container my-4" style="max-width: 960px">
        <h2 class="mb-4 text-center">Assignment & Repository Management</h2>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
          <li class="nav-item">
            <a
              class="nav-link active"
              data-bs-toggle="tab"
              href="#create"
              role="tab"
              >Create Assignment</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#update" role="tab"
              >Update Assignment</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#delete" role="tab"
              >Delete Assignment</a
            >
          </li>
          {% if session['user']['role'] == 'admin' %}
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#repo" role="tab"
              >Repository Management</a
            >
          </li>
          {% endif %}
        </ul>

        <!-- Tabs Content -->
        <div class="tab-content pt-4">
          <!-- Create Assignment -->
          <div class="tab-pane fade show active" id="create" role="tabpanel">
            <div class="d-flex justify-content-center">
              <div class="card shadow" style="width: 100%; max-width: 900px">
                <div
                  class="card-header"
                  style="background-color: #4b0082; color: white"
                >
                  <h5>Create Assignment</h5>
                </div>
                <div class="card-body">
                  <form
                    id="createForm"
                    method="POST"
                    action="/upload-assignment"
                  >
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label>Select Repository</label>
                        <select
                          name="repository_id"
                          id="create_repository_id"
                          class="form-select form-select-sm"
                          required
                        ></select>
                      </div>
                      <div class="col-md-6">
                        <label>Assignment Title</label>
                        <input
                          name="title"
                          id="title"
                          class="form-control form-control-sm"
                          placeholder="Enter title"
                          required
                        />
                      </div>
                      <div class="col-12">
                        <label>Description</label>
                        <textarea
                          name="description"
                          id="desc"
                          class="form-control form-control-sm"
                          rows="2"
                          required
                        ></textarea>
                      </div>
                      <div class="col-12">
                        <label>Hint</label>
                        <textarea
                          name="hint"
                          id="hint"
                          class="form-control form-control-sm"
                          rows="2"
                        ></textarea>
                      </div>
                      <div class="col-md-6">
                        <label>Difficulty</label>
                        <select
                          name="difficulty"
                          id="difficulty"
                          class="form-select form-select-sm"
                          required
                        >
                          <option value="1">Easy</option>
                          <option value="2">Easy Medium</option>
                          <option value="3">Medium</option>
                          <option value="4">Medium Hard</option>
                          <option value="5">Hard</option>
                          <option value="6">Ultra Hard</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label>Due Date</label>
                        <input
                          name="due_date"
                          id="dueDate"
                          class="form-control form-control-sm"
                          type="date"
                          required
                        />
                      </div>
                      <div class="col-12">
                        <label>Examples</label>
                        <div id="createExampleContainer" class="mb-2"></div>
                        <button
                          type="button"
                          class="btn btn-outline-primary btn-sm"
                          onclick="addCreateExample()"
                        >
                          Add Example
                        </button>
                      </div>
                      <div class="col-12">
                        <label>Test Cases</label>
                        <div id="createTestCaseContainer" class="mb-2"></div>
                        <button
                          type="button"
                          class="btn btn-outline-success btn-sm"
                          onclick="addCreateTestCase()"
                        >
                          Add Test Case
                        </button>

                        <!-- CSV upload -->
                        <div class="mt-3">
                          <label class="form-label">Or Upload CSV</label>
                          <input
                            type="file"
                            name="testcase_csv"
                            id="testcase_csv"
                            accept=".csv"
                            class="form-control form-control-sm"
                          />
                          <small class="text-muted"
                            >CSV must have columns:
                            <b>input_data, expected_data</b></small
                          >
                        </div>

                        <!-- Preview -->
                        <div
                          id="csvPreviewContainer"
                          class="mt-3"
                          style="display: none"
                        >
                          <label>CSV Preview (first 5 rows)</label>
                          <table class="table table-sm table-bordered">
                            <thead>
                              <tr>
                                <th>Input</th>
                                <th>Expected Output</th>
                              </tr>
                            </thead>
                            <tbody id="csvPreviewBody"></tbody>
                          </table>
                        </div>
                      </div>

                      <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary btn-sm">
                          Submit Assignment
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Update Assignment -->
          <div class="tab-pane fade" id="update" role="tabpanel">
            <div class="d-flex justify-content-center">
              <div class="card shadow" style="width: 100%; max-width: 700px">
                <div
                  class="card-header"
                  style="background-color: #6d0c1cff; color: white"
                >
                  <h5>Update Assignment</h5>
                </div>
                <div class="card-body">
                  <form id="updateForm" onsubmit="return false;">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label>Select Repository</label>
                        <select
                          name="repository_id"
                          id="update_repository_id"
                          class="form-select form-select-sm"
                          required
                        ></select>
                      </div>
                      <div class="col-md-6">
                        <label>Select Assignment</label>
                        <select
                          name="assignment_id"
                          id="assignSelectUpdate"
                          class="form-select form-select-sm"
                          required
                        ></select>
                      </div>
                      <div class="col-12">
                        <label>Fields to Update</label><br />
                        <div class="form-check form-check-inline">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="editDesc"
                          /><label class="form-check-label" for="editDesc"
                            >Description</label
                          >
                        </div>
                        <div class="form-check form-check-inline">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="editHint"
                          /><label class="form-check-label" for="editHint"
                            >Hint</label
                          >
                        </div>
                        <div class="form-check form-check-inline">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="editDue"
                          /><label class="form-check-label" for="editDue"
                            >Due Date</label
                          >
                        </div>
                        <div class="form-check form-check-inline">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="editExample"
                          /><label class="form-check-label" for="editExample"
                            >Example</label
                          >
                        </div>
                        <div class="form-check form-check-inline">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="editTestCase"
                          /><label class="form-check-label" for="editTestCase"
                            >Test Case</label
                          >
                        </div>
                      </div>
                      <div class="col-12">
                        <button
                          id="processUpdateBtn"
                          class="btn btn-primary btn-sm"
                        >
                          Process Update
                        </button>
                      </div>
                      <div id="updateContainer" class="col-12"></div>
                      <div
                        id="updateFields"
                        class="col-12"
                        style="display: none"
                      ></div>
                      <div class="col-12 text-end">
                        <button
                          id="submitUpdateBtn"
                          class="btn btn-success btn-sm"
                          style="display: none"
                        >
                          Update Assignment
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Delete Assignment -->
          <div class="tab-pane fade" id="delete" role="tabpanel">
            <div class="d-flex justify-content-center">
              <div class="card shadow" style="width: 100%; max-width: 600px">
                <div class="card-header bg-danger text-white">
                  <h5>Delete Assignment</h5>
                </div>
                <div class="card-body">
                  <form id="deleteForm" onsubmit="return false;">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label>Select Repository</label>
                        <select
                          id="delete_repository_id"
                          class="form-select form-select-sm"
                          required
                        ></select>
                      </div>
                      <div class="col-md-6">
                        <label>Select Assignment</label>
                        <select
                          id="delete_assignment_id"
                          class="form-select form-select-sm"
                          required
                          disabled
                        ></select>
                      </div>
                      <div class="col-12 text-end">
                        <button
                          type="button"
                          class="btn btn-danger btn-sm"
                          onclick="submitDelete()"
                        >
                          Delete Assignment
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Repository Management -->
          {% if session['user']['role'] == 'admin' %}
          <div class="tab-pane fade" id="repo" role="tabpanel">
            <div class="row g-4 justify-content-center">
              <div class="col-lg-6">
                <div class="card shadow">
                  <div class="card-header bg-primary text-white">
                    <h5>Create Repository</h5>
                  </div>
                  <div class="card-body">
                    <form id="create_repository_Form" onsubmit="return false;">
                      <div class="mb-3">
                        <label>Repository Title</label>
                        <input
                          type="text"
                          id="repo_title"
                          name="repo_desc"
                          class="form-control form-control-sm"
                          required
                        />
                      </div>
                      <div class="text-end">
                        <button
                          type="button"
                          class="btn btn-primary btn-sm"
                          onclick="create_repository()"
                        >
                          Create
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card shadow">
                  <div class="card-header bg-danger text-white">
                    <h5>Delete Repository</h5>
                  </div>
                  <div class="card-body">
                    <form id="delete_repository_Form" onsubmit="return false;">
                      <div class="mb-3">
                        <label>Select Repository</label>
                        <select
                          id="delete_repo_id"
                          class="form-select form-select-sm"
                          required
                        ></select>
                      </div>
                      <div class="text-end">
                        <button
                          type="button"
                          class="btn btn-danger btn-sm"
                          onclick="delete_repository()"
                        >
                          Delete
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </main>
    <footer>
      {% include 'partials/footer.html' %}
    </footer>

    <script>
      window.addEventListener("DOMContentLoaded", async () => {
        //────────────────────────────────────────────────────────────────────────────
        // 1. Load repositories into dropdowns
        async function loadRepositories() {
          try {
            const res = await fetch("/api/repositories");
            const repos = await res.json();
            [
              "create_repository_id",
              "update_repository_id",
              "delete_repository_id",
              "delete_repo_id",
            ].forEach((id) => {
              const sel = document.getElementById(id);
              if (!sel) return;
              sel.innerHTML =
                "<option value=''>-- Select Repository --</option>";
              repos.forEach((r) => {
                const o = document.createElement("option");
                o.value = r.repository_id;
                o.textContent = `${r.repository_id} - ${r.repo_title}`;
                sel.appendChild(o);
              });
            });
          } catch (e) {
            console.error("Failed to load repositories:", e);
          }
        }
        await loadRepositories();

        //────────────────────────────────────────────────────────────────────────────
        // Populate Delete‑Assignment when a repository is selected
        const deleteRepoSelect = document.getElementById(
          "delete_repository_id"
        );
        const deleteAssignSelect = document.getElementById(
          "delete_assignment_id"
        );

        deleteRepoSelect.addEventListener("change", async function () {
          // 1. Reset and disable until we fetch
          deleteAssignSelect.innerHTML =
            "<option value=''>-- Select Assignment --</option>";
          deleteAssignSelect.disabled = true;

          // 2. If none chosen, stop here
          if (!this.value) return;

          // 3. Fetch and populate
          try {
            const list = await fetch(`/api/assignments/${this.value}`).then(
              (r) => r.json()
            );
            list.forEach((a) => {
              const o = document.createElement("option");
              o.value = a.assignment_id;
              o.textContent = `${a.assignment_id} - ${a.title}`;
              deleteAssignSelect.appendChild(o);
            });
            deleteAssignSelect.disabled = false;
          } catch (e) {
            console.error("Failed to load assignments for delete:", e);
          }
        });

        //────────────────────────────────────────────────────────────────────────────
        // 2. Create Assignment helpers (global for inline onclick)
        window.addCreateExample = () => {
          const c = document.getElementById("createExampleContainer");
          const inp = document.createElement("input");
          inp.type = "text";
          inp.name = "examples[]";
          inp.className = "form-control mb-2";
          inp.placeholder = `Example ${c.children.length + 1}`;
          c.appendChild(inp);
        };
        window.addCreateTestCase = () => {
          const c = document.getElementById("createTestCaseContainer");
          const row = document.createElement("div");
          row.className = "row g-2 mb-2";
          row.innerHTML = `
      <div class="col-md-6">
        <input type="text" name="testcase_input[]" class="form-control" placeholder="Input" required>
      </div>
      <div class="col-md-6">
        <input type="text" name="testcase_expected[]" class="form-control" placeholder="Expected Output" required>
      </div>`;
          c.appendChild(row);
        };
        // initialize Create fields
        addCreateExample();
        for (let i = 0; i < 3; i++) addCreateTestCase();

        //────────────────────────────────────────────────────────────────────────────
        // 3. Create Repository
        window.create_repository = async () => {
          const title = document.getElementById("repo_title").value.trim();
          if (!title) {
            return Swal.fire({
              icon: "warning",
              title: "Title Required",
              text: "Please enter a title.",
              confirmButtonText: "OK",
            });
          }
          try {
            const res = await fetch("/create-repository", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ title }),
            });
            const result = await res.json();
            await Swal.fire({
              icon: result.success ? "success" : "error",
              title: result.success ? "Repository Created" : "Error",
              text:
                result.message ||
                (result.success ? "Repository added." : "Could not create."),
              confirmButtonText: "OK",
            });
            if (result.success) {
              document.getElementById("create_repository_Form").reset();
              await loadRepositories();
            }
          } catch (e) {
            console.error(e);
            Swal.fire("Error", "Something went wrong.", "error");
          }
        };

        //────────────────────────────────────────────────────────────────────────────
        // 4. Update Assignment
        const updateForm = document.getElementById("updateForm");
        updateForm.addEventListener("submit", (e) => e.preventDefault());
        updateForm.addEventListener("keydown", (e) => {
          if (e.key === "Enter") e.preventDefault();
        });

        let selectedData = null;
        const repoSel = document.getElementById("update_repository_id");
        const assignSel = document.getElementById("assignSelectUpdate");

        // on repo change → clear & load assignments
        repoSel.addEventListener("change", async function () {
          assignSel.innerHTML =
            "<option value=''>-- Select Assignment --</option>";
          if (!this.value) return;
          (
            await fetch(`/api/assignments/${this.value}`).then((r) => r.json())
          ).forEach((a) => {
            const o = document.createElement("option");
            o.value = a.assignment_id;
            o.textContent = `${a.assignment_id} - ${a.title}`;
            assignSel.appendChild(o);
          });
        });

        // on assignment change → fetch details & populate
        assignSel.addEventListener("change", async function () {
          if (!this.value) return;
          selectedData = await fetch(`/api/assignment/${this.value}`).then(
            (r) => r.json()
          );
          populateUpdateFields();
        });

        function populateUpdateFields() {
          const cont = document.getElementById("updateFields");
          cont.innerHTML = "";
          cont.style.display = "block";

          const chkDesc = document.getElementById("editDesc");
          const chkHint = document.getElementById("editHint");
          const chkDue = document.getElementById("editDue");
          const chkEx = document.getElementById("editExample");
          const chkTC = document.getElementById("editTestCase");

          if (chkDesc.checked) {
            cont.innerHTML += `<label>Description</label>
        <textarea name="description" class="form-control mb-2">${
          selectedData.description || ""
        }</textarea>`;
          }
          if (chkHint.checked) {
            cont.innerHTML += `<label>Hint</label>
        <input name="hint" class="form-control mb-2" value="${
          selectedData.hint || ""
        }">`;
          }
          if (chkDue.checked) {
            cont.innerHTML += `<label>Due Date</label>
        <input type="date" name="due_date" class="form-control mb-2" value="${
          selectedData.due_date || ""
        }">`;
          }
          if (chkEx.checked) {
            const exLabel = document.createElement("label");
            exLabel.textContent = "Examples";
            cont.appendChild(exLabel);

            (selectedData.examples || []).forEach((ex) => {
              const i = document.createElement("input");
              i.name = "examples[]";
              i.className = "form-control mb-2";
              i.value = ex;
              cont.appendChild(i);
            });

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn btn-outline-primary mb-2";
            btn.textContent = "Add Example";
            btn.addEventListener("click", () => {
              const i = document.createElement("input");
              i.name = "examples[]";
              i.className = "form-control mb-2";
              i.placeholder = "New example";
              cont.insertBefore(i, btn);
            });
            cont.appendChild(btn);
          }

          if (chkTC.checked) {
            const tcLabel = document.createElement("label");
            tcLabel.textContent = "Test Cases";
            cont.appendChild(tcLabel);

            (selectedData.test_cases || []).forEach((tc) => {
              const row = document.createElement("div");
              row.className = "row g-2 mb-2";
              row.innerHTML = `
      <div class="col"><input name="testcase_input[]" class="form-control" value="${tc.input}"></div>
      <div class="col"><input name="testcase_expected[]" class="form-control" value="${tc.expected}"></div>`;
              cont.appendChild(row);
            });

            const btn2 = document.createElement("button");
            btn2.type = "button";
            btn2.className = "btn btn-outline-success mb-2";
            btn2.textContent = "Add Test Case";
            btn2.addEventListener("click", () => {
              const r = document.createElement("div");
              r.className = "row g-2 mb-2";
              r.innerHTML = `
      <div class="col"><input name="testcase_input[]" class="form-control" placeholder="Input"></div>
      <div class="col"><input name="testcase_expected[]" class="form-control" placeholder="Expected Output"></div>`;
              cont.insertBefore(r, btn2);
            });
            cont.appendChild(btn2);
          }
          document.getElementById("submitUpdateBtn").style.display =
            "inline-block";
        }

        document
          .getElementById("processUpdateBtn")
          .addEventListener("click", populateUpdateFields);

        document
          .getElementById("submitUpdateBtn")
          .addEventListener("click", async () => {
            const cont = document.getElementById("updateFields");
            const payload = { assignment_id: selectedData.assignment_id };
            if (editDesc.checked)
              payload.description = cont.querySelector(
                "[name='description']"
              ).value;
            if (editHint.checked)
              payload.hint = cont.querySelector("[name='hint']").value;
            if (editDue.checked)
              payload.due_date = cont.querySelector("[name='due_date']").value;
            if (editExample.checked)
              payload.examples = Array.from(
                cont.querySelectorAll("[name='examples[]']")
              ).map((i) => i.value);
            if (editTestCase.checked)
              payload.test_cases = Array.from(
                cont.querySelectorAll("[name='testcase_input[]']")
              ).map((i, idx) => ({
                input: i.value,
                expected: cont.querySelectorAll("[name='testcase_expected[]']")[
                  idx
                ].value,
              }));

            const res = await fetch("/update-assignment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const result = await res.json();
            await Swal.fire({
              icon: result.success ? "success" : "error",
              title: result.success ? "Assignment Updated" : "Update Failed",
              text:
                result.message ||
                (result.success ? "Saved." : "Could not update."),
              confirmButtonText: "OK",
            });
            if (result.success) {
              updateForm.reset();
              cont.style.display = "none";
              document.getElementById("submitUpdateBtn").style.display = "none";
              assignSel.innerHTML =
                "<option value=''>-- Select Assignment --</option>";
            }
          });

        //────────────────────────────────────────────────────────────────────────────
        // 5. Delete Assignment (global for inline onclick)
        window.submitDelete = async () => {
          const repoId = document.getElementById("delete_repository_id").value;
          const aid = document.getElementById("delete_assignment_id").value;
          if (!repoId || !aid) {
            return Swal.fire(
              "Warning",
              "Select both repo & assignment",
              "warning"
            );
          }
          const ok = await Swal.fire({
            title: "Are you sure?",
            text: `Delete assignment #${aid}?`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete",
            cancelButtonText: "Cancel",
          });
          if (!ok.isConfirmed) return;
          const res = await fetch("/delete-assignment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ assignment_id: +aid }),
          });
          const result = await res.json();
          await Swal.fire(
            result.success ? "Deleted" : "Error",
            result.message || "",
            result.success ? "success" : "error"
          );
          if (result.success) {
            const sel = document.getElementById("delete_assignment_id");
            sel.innerHTML = "<option value=''>-- Select Assignment --</option>";
            (
              await fetch(`/api/assignments/${repoId}`).then((r) => r.json())
            ).forEach((a) => {
              const o = document.createElement("option");
              o.value = a.assignment_id;
              o.textContent = `${a.assignment_id} – ${a.title}`;
              sel.appendChild(o);
            });
          }
        };

        //────────────────────────────────────────────────────────────────────────────
        // 6. Delete Repository (global for inline onclick)
        window.delete_repository = async () => {
          const rid = document.getElementById("delete_repo_id").value;
          if (!rid) {
            return Swal.fire({
              icon: "warning",
              title: "Select a Repository",
              text: "Please choose one.",
              confirmButtonText: "OK",
            });
          }
          const ok = await Swal.fire({
            title: "Are you sure?",
            text: "This will delete repository & all assignments.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete",
            cancelButtonText: "Cancel",
          });
          if (!ok.isConfirmed) return;
          try {
            const res = await fetch("/delete-repository", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ repository_id: rid }),
            });
            const result = await res.json();
            await Swal.fire(
              result.success ? "Deleted" : "Error",
              result.success
                ? "Repository removed."
                : result.error || "Could not delete.",
              result.success ? "success" : "error"
            );
            if (result.success) {
              document.getElementById("delete_repo_id").value = "";
              await loadRepositories();
            }
          } catch (e) {
            console.error(e);
            Swal.fire("Error", "Something went wrong.", "error");
          }
        };
      }); // end DOMContentLoaded

      // Auto-select Update tab and assignment if query params exist
      const urlParams = new URLSearchParams(window.location.hash.split("?")[1]);
      const aid = urlParams.get("assignment_id");
      const rid = urlParams.get("repo_id");

      if (window.location.hash.startsWith("#update")) {
        // Switch to update tab
        document.querySelector('a[href="#update"]').click();

        if (rid) {
          document.getElementById("update_repository_id").value = rid;
          // trigger repo change event to load assignments
          document
            .getElementById("update_repository_id")
            .dispatchEvent(new Event("change"));
        }

        if (aid) {
          // wait a bit for repo assignments to load
          setTimeout(() => {
            document.getElementById("assignSelectUpdate").value = aid;
            document
              .getElementById("assignSelectUpdate")
              .dispatchEvent(new Event("change"));
          }, 800);
        }
      }
      //────────────────────────────────────────────────────────────────────────────
      // 7. Intercept Create Assignment form submit (with CSV + SweetAlert handling)
      const createForm = document.getElementById("createForm");
      if (createForm) {
        createForm.addEventListener("submit", async (e) => {
          e.preventDefault(); // stop normal form submit

          const formData = new FormData(createForm);

          try {
            const res = await fetch("/upload-assignment", {
              method: "POST",
              body: formData,
            });

            const result = await res.json();

            if (result.success) {
              await Swal.fire({
                icon: "success",
                title: "Success",
                text: result.message,
                confirmButtonText: "OK",
              });
              window.location.href = "/create-assignment";
            } else {
              await Swal.fire({
                icon: "error",
                title: "Upload Failed",
                text: result.message || "Invalid CSV or form data.",
                confirmButtonText: "Try Again",
              });
            }
          } catch (err) {
            console.error("❌ Upload error:", err);
            Swal.fire({
              icon: "error",
              title: "Unexpected Error",
              text: "Something went wrong. Please try again.",
              confirmButtonText: "OK",
            });
          }
        });
      }

      //────────────────────────────────────────────────────────────────────────────
      // CSV Preview Logic
      const csvInput = document.getElementById("testcase_csv");
      if (csvInput) {
        csvInput.addEventListener("change", function () {
          const file = this.files[0];
          if (!file) {
            document.getElementById("csvPreviewContainer").style.display =
              "none";
            return;
          }

          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
              const required = ["input_data", "expected_data"];
              const missing = required.filter(
                (h) => !results.meta.fields.includes(h)
              );

              if (missing.length > 0) {
                Swal.fire({
                  icon: "error",
                  title: "Invalid CSV",
                  text: `Missing required headers: ${missing.join(", ")}`,
                });
                csvInput.value = ""; // reset file
                document.getElementById("csvPreviewContainer").style.display =
                  "none";
                return;
              }

              // ✅ Build preview (first 5 rows)
              const previewBody = document.getElementById("csvPreviewBody");
              previewBody.innerHTML = "";

              results.data.slice(0, 5).forEach((row) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${row.input_data || ""}</td>
            <td>${row.expected_data || ""}</td>
          `;
                previewBody.appendChild(tr);
              });

              document.getElementById("csvPreviewContainer").style.display =
                "block";
            },
            error: function (err) {
              Swal.fire({
                icon: "error",
                title: "CSV Error",
                text: err.message || "Could not parse CSV.",
              });
            },
          });
        });
      }

      VANTA.WAVES({
        el: "#vanta-bg",
        mouseControls: true,
        touchControls: true,
        // feel‑free to tweak:
        minHeight: 200.0,
        minWidth: 200.0,
        scale: 1.0,
        scaleMobile: 1.0,
        backgroundColor: 0xfefefe, // match your page background
        color1: 0x00bfa6, // primary wave color
        color2: 0xff7e5f, // secondary wave color
        waveHeight: 20.0, // height of waves
        waveSpeed: 1.0, // speed of animation
        zoom: 1.0, // overall scale
      
      });
    </script>
  </body>
</html>
